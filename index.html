<!DOCTYPE html>
<html lang="es">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Predicci√≥n de Abandono Estudiantil</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.95;
        }

        .progress-container {
            background: white;
            padding: 40px;
            border-bottom: 3px solid #e9ecef;
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .progress-line {
            position: absolute;
            top: 30px;
            left: 0;
            right: 0;
            height: 4px;
            background: #e9ecef;
            z-index: 0;
        }

        .progress-line-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.5s ease;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
            position: relative;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            font-weight: bold;
            color: #6c757d;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-circle {
            background: #00b894;
            color: white;
        }

        .step-label {
            margin-top: 15px;
            font-weight: 600;
            color: #6c757d;
            text-align: center;
        }

        .step.active .step-label {
            color: #667eea;
        }

        .step.completed .step-label {
            color: #00b894;
        }

        .upload-section {
            padding: 40px;
            background: #f8f9fa;
            display: none;
        }

        .upload-section.active {
            display: block;
        }

        .section-title {
            font-size: 2em;
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
        }

        .section-description {
            text-align: center;
            color: #6c757d;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .upload-box {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-box:hover {
            border-color: #764ba2;
            background: #f8f9ff;
            transform: scale(1.02);
        }

        .upload-box.dragover {
            background: #e8eaff;
            border-color: #764ba2;
        }

        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.3em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #6c757d;
            font-size: 0.95em;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
        }

        .alert {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }

        .alert-success {
            background: #e8f5e9;
            color: #388e3c;
            border-left: 4px solid #388e3c;
        }

        .alert-warning {
            background: #fff3e0;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }

        .model-info {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .model-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .example-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .example-section h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .example-section pre {
            background: white;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 0;
        }

        .results-section {
            padding: 40px;
            display: none;
        }

        .results-section.active {
            display: block;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .kpi-value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .predictions-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-riesgo-alto {
            background: #fee;
            color: #c00;
        }

        .badge-riesgo-medio {
            background: #ffeaa7;
            color: #d63031;
        }

        .badge-riesgo-bajo {
            background: #dfe6e9;
            color: #00b894;
        }

        .btn-group {
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 0;
                margin: 0;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header p {
                font-size: 1em;
            }

            .progress-steps {
                flex-direction: column;
                gap: 20px;
            }

            .progress-line {
                display: none;
            }

            .section-title {
                font-size: 1.5em;
            }

            .section-description {
                font-size: 1em;
            }

            .upload-section {
                padding: 20px;
            }

            .upload-box {
                padding: 30px 20px;
            }

            .upload-icon {
                font-size: 3em;
            }

            .upload-text {
                font-size: 1.1em;
            }

            .btn {
                padding: 12px 30px;
                font-size: 1em;
                margin: 8px 5px;
            }

            .kpi-container {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .kpi-card {
                padding: 20px;
            }

            .kpi-value {
                font-size: 2em;
            }

            .model-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
            }

            .stat-card {
                padding: 15px;
            }

            .stat-value {
                font-size: 1.8em;
            }

            .grid-2 {
                grid-template-columns: 1fr;
            }

            .predictions-table {
                padding: 15px;
                overflow-x: auto;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 10px 8px;
                white-space: nowrap;
            }

            .example-section pre {
                font-size: 0.75em;
                padding: 10px;
            }

            #modalGuia > div {
                margin: 20px;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            #modalGuia h2 {
                font-size: 1.8em;
            }

            #modalGuia h3 {
                font-size: 1.2em;
            }

            #modalGuia table {
                font-size: 0.85em;
            }

            #modalGuia th, #modalGuia td {
                padding: 8px;
            }

            #modalGuia pre {
                font-size: 0.75em;
            }

            .results-section {
                padding: 20px;
            }

            .chart-container {
                padding: 15px;
            }

            body {
                padding: 0;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .section-title {
                font-size: 1.3em;
            }

            .kpi-container {
                grid-template-columns: 1fr;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .btn-group {
                display: flex;
                flex-direction: column;
            }

            .progress-container {
                padding: 20px;
            }

            .step-circle {
                width: 50px;
                height: 50px;
                font-size: 1.2em;
            }

            .step-label {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéì Sistema de Predicci√≥n de Abandono Estudiantil</h1>
            <p>Entrenamiento y Predicci√≥n con IA - Jhonny Mart√≠nez - Jean Parra - Juan Hurtado</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-container">
            <div class="progress-steps">
                <div class="progress-line">
                    <div class="progress-line-fill" id="progressFill"></div>
                </div>
                <div class="step active" id="step1">
                    <div class="step-circle">1</div>
                    <div class="step-label">Entrenar Modelo</div>
                </div>
                <div class="step" id="step2">
                    <div class="step-circle">2</div>
                    <div class="step-label">Hacer Predicciones</div>
                </div>
                <div class="step" id="step3">
                    <div class="step-circle">3</div>
                    <div class="step-label">Ver Resultados</div>
                </div>
            </div>
        </div>

        <!-- ETAPA 1: Entrenamiento -->
        <div class="upload-section active" id="section1">
            <div class="section-title">ü§ñ ETAPA 1: Entrenar el Modelo</div>
            <div class="section-description">
                Carga un archivo CSV con datos hist√≥ricos de estudiantes (debe incluir la columna "abandono")
            </div>

            <div class="alert alert-info">
                <strong>üìã Requisito:</strong> El archivo debe contener estudiantes con informaci√≥n conocida de abandono (0 = contin√∫a, 1 = abandon√≥).
                Esto permitir√° entrenar el modelo de IA.
            </div>

            <div class="upload-box" id="uploadBox1">
                <div class="upload-icon">üìö</div>
                <div class="upload-text">Arrastra el archivo de entrenamiento aqu√≠</div>
                <div class="upload-subtext">CSV con datos hist√≥ricos | M√°ximo 10MB</div>
                <input type="file" id="fileInput1" accept=".csv">
            </div>

            <div class="btn-group">
                <button class="btn" onclick="document.getElementById('fileInput1').click()">
                    üìÅ Seleccionar Archivo de Entrenamiento
                </button>
                <button class="btn btn-success" onclick="generarEjemploEntrenamiento()">
                    ‚ú® Generar Datos de Ejemplo
                </button>
            </div>

            <div class="example-section">
                <h3>üìã Formato del archivo de ENTRENAMIENTO:</h3>
                <pre><code>nombre,apellido,edad,genero,carrera,promedio_cons1,promedio_cons2,abandono
Juan,P√©rez,22,Hombre,Ingenier√≠a,3.2,3.0,1
Ana,Garc√≠a,19,Mujer,Medicina,4.5,4.3,0
Carlos,L√≥pez,25,Hombre,Derecho,2.1,2.0,1</code></pre>
                <p style="margin-top: 10px; color: #6c757d;">
                    <strong>‚ö†Ô∏è IMPORTANTE:</strong> Debe incluir la columna <code>abandono</code> con valores 0 (contin√∫a) o 1 (abandon√≥).
                </p>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="mostrarGuiaCompleta()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        üìñ Ver Gu√≠a Completa de Columnas
                    </button>
                </div>
            </div>
        </div>

        <!-- ETAPA 2: Predicci√≥n -->
        <div class="upload-section" id="section2">
            <div class="section-title">üîÆ ETAPA 2: Hacer Predicciones</div>
            <div class="section-description">
                Carga un archivo CSV con estudiantes nuevos para predecir si abandonar√°n
            </div>

            <div class="alert alert-success" id="modelInfo">
                <strong>‚úÖ Modelo entrenado exitosamente</strong>
                <div class="model-info">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä Informaci√≥n del Modelo</h3>
                    <div class="model-stats" id="modelStats"></div>
                </div>
            </div>

            <div class="upload-box" id="uploadBox2">
                <div class="upload-icon">üîç</div>
                <div class="upload-text">Arrastra el archivo para predicci√≥n aqu√≠</div>
                <div class="upload-subtext">CSV con estudiantes nuevos | La columna "abandono" es opcional</div>
                <input type="file" id="fileInput2" accept=".csv">
            </div>

            <div class="btn-group">
                <button class="btn" onclick="document.getElementById('fileInput2').click()">
                    üìÅ Seleccionar Archivo para Predicci√≥n
                </button>
                <button class="btn btn-success" onclick="generarEjemploPrediccion()">
                    ‚ú® Generar Datos de Ejemplo
                </button>
                <button class="btn btn-secondary" onclick="volverEtapa1()">
                    ‚¨ÖÔ∏è Volver a Entrenar
                </button>
            </div>

            <div class="example-section">
                <h3>üìã Formato del archivo de PREDICCI√ìN:</h3>
                <pre><code>nombre,apellido,edad,genero,carrera,promedio_cons1,promedio_cons2
Mar√≠a,Gonz√°lez,21,Mujer,Ingenier√≠a,3.5,3.4
Pedro,Ram√≠rez,20,Hombre,Medicina,2.8,2.7</code></pre>
                <p style="margin-top: 10px; color: #6c757d;">
                    <strong>üí° Nota:</strong> La columna <code>abandono</code> NO es necesaria. El modelo la predecir√°.
                </p>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="mostrarGuiaCompleta()" style="background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);">
                        üìñ Ver Gu√≠a Completa de Columnas
                    </button>
                </div>
            </div>
        </div>

        <!-- ETAPA 3: Resultados -->
        <div class="results-section" id="section3">
            <div class="section-title">üìä ETAPA 3: Resultados de Predicci√≥n</div>
            
            <div class="alert alert-success">
                <strong>‚úÖ Predicci√≥n completada</strong> - El modelo ha analizado todos los estudiantes
            </div>

            <div class="kpi-container" id="kpiResults"></div>

            <!-- Gr√°ficas de An√°lisis -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 30px;">
                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üéì Abandono por Carrera</h3>
                    <canvas id="chartCarreraAbandono"></canvas>
                </div>

                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üë• Estudiantes por Carrera</h3>
                    <canvas id="chartCarreraTotal"></canvas>
                </div>

                <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
                    <h3 style="color: #667eea; margin-bottom: 20px; text-align: center;">üë´ Abandono por G√©nero</h3>
                    <canvas id="chartGeneroAbandono"></canvas>
                </div>
            </div>

            <div class="predictions-table">
                <h3 style="color: #667eea; margin-bottom: 20px;">üéØ Predicciones Detalladas</h3>
                <div id="tableResults"></div>
            </div>

            <div class="btn-group">
                <button class="btn btn-success" onclick="descargarPredicciones()">
                    üíæ Descargar Predicciones CSV
                </button>
                <button class="btn" onclick="nuevaPrediccion()">
                    üîÑ Nueva Predicci√≥n
                </button>
                <button class="btn btn-secondary" onclick="volverInicio()">
                    üè† Volver al Inicio
                </button>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Procesando datos...</p>
        </div>

        <!-- Modal Gu√≠a Completa -->
        <div id="modalGuia" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
            <div style="max-width: 1200px; margin: 50px auto; background: white; border-radius: 20px; padding: 40px; position: relative;">
                <button onclick="cerrarGuiaCompleta()" style="position: absolute; top: 20px; right: 20px; background: #e74c3c; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 1.5em; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">√ó</button>
                
                <h2 style="color: #667eea; text-align: center; margin-bottom: 30px; font-size: 2.5em;">
                    üìñ GU√çA COMPLETA DE COLUMNAS
                </h2>
                <p style="text-align: center; color: #6c757d; margin-bottom: 40px; font-size: 1.2em;">
                    Conoce todas las columnas que puedes incluir en tu archivo para obtener mejores resultados
                </p>

                <div style="background: white; border: 2px solid #667eea; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #667eea; margin-bottom: 20px;">‚úÖ COLUMNAS OBLIGATORIAS (M√≠nimo requerido)</div>
                    <p style="margin-bottom: 15px; color: #555;">Estas son <strong>necesarias</strong> para que el programa funcione:</p>
                    
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr style="background: #667eea;">
                                <th style="color: white; padding: 15px;">Columna</th>
                                <th style="color: white; padding: 15px;">Descripci√≥n</th>
                                <th style="color: white; padding: 15px;">Ejemplo</th>
                                <th style="color: white; padding: 15px;">Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px;"><strong>edad</strong></td>
                                <td style="padding: 12px;">Edad del estudiante</td>
                                <td style="padding: 12px;">22, 19, 25</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">N√∫mero</span></td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 12px;"><strong>genero</strong></td>
                                <td style="padding: 12px;">G√©nero del estudiante</td>
                                <td style="padding: 12px;">Hombre, Mujer</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #9b59b6; color: white;">Texto</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;"><strong>carrera</strong></td>
                                <td style="padding: 12px;">Nombre de la carrera</td>
                                <td style="padding: 12px;">Ingenier√≠a, Medicina</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #9b59b6; color: white;">Texto</span></td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 12px;"><strong>promedio_cons1</strong></td>
                                <td style="padding: 12px;">Promedio del primer per√≠odo</td>
                                <td style="padding: 12px;">3.2, 4.5, 2.1</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">N√∫mero (1.0-5.0)</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;"><strong>promedio_cons2</strong></td>
                                <td style="padding: 12px;">Promedio del segundo per√≠odo</td>
                                <td style="padding: 12px;">3.0, 4.3, 2.0</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">N√∫mero (1.0-5.0)</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="background: white; border: 2px solid #00b894; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #00b894; margin-bottom: 20px;">üåü COLUMNAS RECOMENDADAS (Mejoran el an√°lisis)</div>
                    <p style="margin-bottom: 15px; color: #555;">Estas <strong>mejoran mucho</strong> la predicci√≥n pero no son obligatorias:</p>
                    
                    <table style="width: 100%; margin-top: 20px;">
                        <thead>
                            <tr style="background: #00b894;">
                                <th style="color: white; padding: 15px;">Columna</th>
                                <th style="color: white; padding: 15px;">Descripci√≥n</th>
                                <th style="color: white; padding: 15px;">Ejemplo</th>
                                <th style="color: white; padding: 15px;">Tipo</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px;"><strong>nombre</strong></td>
                                <td style="padding: 12px;">Nombre del estudiante</td>
                                <td style="padding: 12px;">Juan, Ana, Mar√≠a</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #9b59b6; color: white;">Texto</span></td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 12px;"><strong>apellido</strong></td>
                                <td style="padding: 12px;">Apellido del estudiante</td>
                                <td style="padding: 12px;">P√©rez, Garc√≠a, L√≥pez</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #9b59b6; color: white;">Texto</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;"><strong>abandono</strong></td>
                                <td style="padding: 12px;">¬øAbandon√≥? (0=No, 1=S√≠)</td>
                                <td style="padding: 12px;">0, 1</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">N√∫mero (0 o 1)</span></td>
                            </tr>
                        </tbody>
                    </table>
                    
                    <div class="alert alert-warning" style="margin-top: 15px;">
                        <strong>üí° Nota:</strong> Si no incluyes <code>abandono</code> en el archivo de predicci√≥n, el programa lo calcular√°. Pero es <strong>OBLIGATORIO</strong> en el archivo de entrenamiento.
                    </div>
                </div>

                <div style="background: white; border: 2px solid #f39c12; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #f39c12; margin-bottom: 20px;">üí™ COLUMNAS OPCIONALES AVANZADAS (Para an√°lisis profundo)</div>
                    <p style="margin-bottom: 15px; color: #555;">Estas columnas hacen que el modelo de IA sea <strong>mucho m√°s preciso</strong>:</p>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üìö Informaci√≥n Acad√©mica:</h3>
                    <table style="width: 100%; margin-top: 15px;">
                        <thead>
                            <tr style="background: #f39c12;">
                                <th style="color: white; padding: 15px;">Columna</th>
                                <th style="color: white; padding: 15px;">Descripci√≥n</th>
                                <th style="color: white; padding: 15px;">Ejemplo</th>
                                <th style="color: white; padding: 15px;">Rango</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px;"><strong>tiene_beca</strong></td>
                                <td style="padding: 12px;">¬øTiene beca?</td>
                                <td style="padding: 12px;">0 (No), 1 (S√≠)</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">0 o 1</span></td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 12px;"><strong>tiene_deudas</strong></td>
                                <td style="padding: 12px;">¬øTiene deudas?</td>
                                <td style="padding: 12px;">0 (No), 1 (S√≠)</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">0 o 1</span></td>
                            </tr>
                            <tr>
                                <td style="padding: 12px;"><strong>horas_estudio_semanal</strong></td>
                                <td style="padding: 12px;">Horas de estudio por semana</td>
                                <td style="padding: 12px;">10, 15, 20</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">0-40</span></td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 12px;"><strong>ausencias_mes</strong></td>
                                <td style="padding: 12px;">Faltas al mes</td>
                                <td style="padding: 12px;">2, 5, 10</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">0-30</span></td>
                            </tr>
                        </tbody>
                    </table>

                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Informaci√≥n Familiar/Social:</h3>
                    <table style="width: 100%; margin-top: 15px;">
                        <thead>
                            <tr style="background: #9b59b6;">
                                <th style="color: white; padding: 15px;">Columna</th>
                                <th style="color: white; padding: 15px;">Descripci√≥n</th>
                                <th style="color: white; padding: 15px;">Ejemplo</th>
                                <th style="color: white; padding: 15px;">Rango</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px;"><strong>apoyo_familiar</strong></td>
                                <td style="padding: 12px;">Nivel de apoyo familiar</td>
                                <td style="padding: 12px;">5, 7, 9</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">1-10</span></td>
                            </tr>
                            <tr style="background: #f8f9fa;">
                                <td style="padding: 12px;"><strong>problemas_economicos</strong></td>
                                <td style="padding: 12px;">Nivel de problemas econ√≥micos</td>
                                <td style="padding: 12px;">3, 6, 8</td>
                                <td style="padding: 12px;"><span class="badge" style="background: #3498db; color: white;">1-10</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div style="background: #e8f5e9; border: 2px solid #00b894; border-radius: 15px; padding: 25px; margin-bottom: 30px;">
                    <div style="font-size: 1.5em; font-weight: bold; color: #00b894; margin-bottom: 20px;">üìù EJEMPLOS DE ARCHIVOS</div>
                    
                    <h3 style="color: #667eea; margin: 20px 0 10px 0;">üìÑ EJEMPLO 1: M√≠nimo b√°sico</h3>
                    <pre style="background: white; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #ddd;"><code>edad,genero,carrera,promedio_cons1,promedio_cons2
22,Hombre,Ingenier√≠a,3.2,3.0
19,Mujer,Medicina,4.5,4.3
25,Hombre,Derecho,2.1,2.0</code></pre>
                    <p style="margin-top: 10px; color: #555;">
                        ‚ö†Ô∏è <strong>Solo para predicci√≥n.</strong> Para entrenar necesitas incluir la columna <code>abandono</code>.
                    </p>

                    <h3 style="color: #667eea; margin: 30px 0 10px 0;">‚≠ê EJEMPLO 2: Recomendado (para entrenamiento)</h3>
                    <pre style="background: white; padding: 15px; border-radius: 8px; overflow-x: auto; border: 1px solid #ddd;"><code>nombre,apellido,edad,genero,carrera,promedio_cons1,promedio_cons2,abandono
Juan,P√©rez,22,Hombre,Ingenier√≠a,3.2,3.0,1
Ana,Garc√≠a,19,Mujer,Medicina,4.5,4.3,0
Carlos,L√≥pez,25,Hombre,Derecho,2.1,2.0,1</code></pre>
                    <p style="margin-top: 10px; color: #555;">
                        ‚úÖ <strong>Perfecto para entrenar el modelo.</strong> Incluye nombres y columna abandono.
                    </p>

                    <h3 style="color: #667eea; margin: 30px 0 10px 0;">üöÄ EJEMPLO 3: Completo profesional</h3>
                    <pre style="background: white; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 0.85em; border: 1px solid #ddd;"><code>nombre,apellido,edad,genero,carrera,promedio_cons1,promedio_cons2,abandono,tiene_beca,tiene_deudas,horas_estudio_semanal,ausencias_mes,apoyo_familiar,problemas_economicos
Juan,P√©rez,22,Hombre,Ingenier√≠a,3.2,3.0,1,0,1,10,8,5,7
Ana,Garc√≠a,19,Mujer,Medicina,4.5,4.3,0,1,0,25,2,9,2
Carlos,L√≥pez,25,Hombre,Derecho,2.1,2.0,1,0,1,5,15,3,9</code></pre>
                    <p style="margin-top: 10px; color: #555;">
                        üéØ <strong>M√°xima precisi√≥n.</strong> Incluye todas las columnas opcionales para predicciones m√°s exactas.
                    </p>
                </div>

                <div class="alert alert-success">
                    <strong>üí° Consejo:</strong> Empieza con las columnas obligatorias y agrega m√°s seg√∫n necesites mayor precisi√≥n en las predicciones.
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="cerrarGuiaCompleta()" style="font-size: 1.2em; padding: 20px 50px;">
                        ‚úÖ Entendido - Cerrar Gu√≠a
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let modeloEntrenado = null;
        let datosEntrenamiento = null;
        let prediccionesResultado = null;

        // Configurar drag & drop para etapa 1
        setupDragDrop('uploadBox1', 'fileInput1', procesarArchivoEntrenamiento);
        
        // Configurar drag & drop para etapa 2
        setupDragDrop('uploadBox2', 'fileInput2', procesarArchivoPrediccion);

        document.getElementById('fileInput1').addEventListener('change', (e) => {
            if (e.target.files.length > 0) procesarArchivoEntrenamiento(e.target.files[0]);
        });

        document.getElementById('fileInput2').addEventListener('change', (e) => {
            if (e.target.files.length > 0) procesarArchivoPrediccion(e.target.files[0]);
        });

        function setupDragDrop(boxId, inputId, callback) {
            const box = document.getElementById(boxId);
            const input = document.getElementById(inputId);

            box.addEventListener('click', () => input.click());
            
            box.addEventListener('dragover', (e) => {
                e.preventDefault();
                box.classList.add('dragover');
            });

            box.addEventListener('dragleave', () => {
                box.classList.remove('dragover');
            });

            box.addEventListener('drop', (e) => {
                e.preventDefault();
                box.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    callback(e.dataTransfer.files[0]);
                }
            });
        }

        function mostrarLoading(texto) {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loading').classList.add('active');
        }

        function ocultarLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function actualizarProgreso(etapa) {
            const steps = ['step1', 'step2', 'step3'];
            const fillWidth = ((etapa - 1) / 2) * 100;
            
            document.getElementById('progressFill').style.width = fillWidth + '%';
            
            steps.forEach((stepId, index) => {
                const step = document.getElementById(stepId);
                step.classList.remove('active', 'completed');
                
                if (index + 1 < etapa) {
                    step.classList.add('completed');
                } else if (index + 1 === etapa) {
                    step.classList.add('active');
                }
            });
        }

        function cambiarSeccion(seccionId) {
            ['section1', 'section2', 'section3'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(seccionId).classList.add('active');
        }

        // ETAPA 1: Procesar archivo de entrenamiento
        function procesarArchivoEntrenamiento(file) {
            mostrarLoading('Procesando archivo de entrenamiento...');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    entrenarModelo(results.data);
                },
                error: (error) => {
                    alert('Error al leer el archivo: ' + error.message);
                    ocultarLoading();
                }
            });
        }

        function entrenarModelo(datos) {
            try {
                // Validar que tenga columna abandono
                if (!datos[0].hasOwnProperty('abandono')) {
                    alert('‚ùå Error: El archivo de entrenamiento debe tener la columna "abandono"');
                    ocultarLoading();
                    return;
                }

                // Limpiar y preparar datos
                datos = limpiarDatos(datos);
                
                if (datos.length < 5) {
                    alert('‚ùå Error: Se necesitan al menos 5 registros para entrenar el modelo');
                    ocultarLoading();
                    return;
                }

                datosEntrenamiento = datos;

                // Entrenar modelo simple (regresi√≥n log√≠stica simulada)
                modeloEntrenado = entrenarModeloSimple(datos);

                // Mostrar informaci√≥n del modelo
                mostrarInfoModelo(datos);

                // Cambiar a etapa 2
                setTimeout(() => {
                    ocultarLoading();
                    actualizarProgreso(2);
                    cambiarSeccion('section2');
                }, 1000);

            } catch (error) {
                alert('Error al entrenar el modelo: ' + error.message);
                ocultarLoading();
            }
        }

        function entrenarModeloSimple(datos) {
            // Calcular estad√≠sticas del conjunto de entrenamiento
            const abandonan = datos.filter(d => d.abandono === 1);
            const continuan = datos.filter(d => d.abandono === 0);

            const promedioAbandonan = abandonan.reduce((sum, d) => sum + d.promedio_general, 0) / abandonan.length;
            const promedioContinuan = continuan.reduce((sum, d) => sum + d.promedio_general, 0) / continuan.length;

            // Calcular accuracy mediante validaci√≥n cruzada simple
            let prediccionesCorrectas = 0;
            const umbral = (promedioAbandonan + promedioContinuan) / 2;

            datos.forEach(estudiante => {
                const prediccion = estudiante.promedio_general < umbral ? 1 : 0;
                if (prediccion === estudiante.abandono) {
                    prediccionesCorrectas++;
                }
            });

            const accuracy = (prediccionesCorrectas / datos.length) * 100;

            return {
                umbralPromedio: umbral,
                promedioAbandonan,
                promedioContinuan,
                tasaAbandonoBase: abandonan.length / datos.length,
                totalEntrenamiento: datos.length,
                abandonanEntrenamiento: abandonan.length,
                continuanEntrenamiento: continuan.length,
                accuracy: accuracy
            };
        }

        function mostrarInfoModelo(datos) {
            const abandonan = datos.filter(d => d.abandono === 1).length;
            const continuan = datos.length - abandonan;
            const accuracy = modeloEntrenado.accuracy;

            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-label">üìä Total Entrenamiento</div>
                    <div class="stat-value">${datos.length}</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="stat-label">‚ùå Abandonaron</div>
                    <div class="stat-value">${abandonan}</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">
                    <div class="stat-label">‚úÖ Continuaron</div>
                    <div class="stat-value">${continuan}</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <div class="stat-label">üéØ Accuracy (Precisi√≥n)</div>
                    <div class="stat-value">${accuracy.toFixed(1)}%</div>
                </div>
            `;

            document.getElementById('modelStats').innerHTML = statsHTML;
        }

        // ETAPA 2: Procesar archivo de predicci√≥n
        function procesarArchivoPrediccion(file) {
            if (!modeloEntrenado) {
                alert('‚ùå Primero debes entrenar el modelo');
                return;
            }

            mostrarLoading('Realizando predicciones...');
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    hacerPredicciones(results.data);
                },
                error: (error) => {
                    alert('Error al leer el archivo: ' + error.message);
                    ocultarLoading();
                }
            });
        }

        function hacerPredicciones(datos) {
            try {
                // Limpiar datos
                datos = limpiarDatos(datos, false);

                // Hacer predicciones para cada estudiante
                const predicciones = datos.map(estudiante => {
                    const prediccion = predecirAbandono(estudiante, modeloEntrenado);
                    return {
                        ...estudiante,
                        prediccion_abandono: prediccion.abandono,
                        probabilidad: prediccion.probabilidad,
                        nivel_riesgo: prediccion.nivelRiesgo
                    };
                });

                prediccionesResultado = predicciones;

                // Mostrar resultados
                setTimeout(() => {
                    ocultarLoading();
                    actualizarProgreso(3);
                    cambiarSeccion('section3');
                    mostrarResultados(predicciones);
                }, 1000);

            } catch (error) {
                alert('Error al hacer predicciones: ' + error.message);
                ocultarLoading();
            }
        }

        function predecirAbandono(estudiante, modelo) {
            // Algoritmo simple basado en promedio y otras caracter√≠sticas
            let probabilidad = 0;

            // Factor 1: Promedio general (60% de peso)
            if (estudiante.promedio_general < 3.0) {
                probabilidad += 0.6;
            } else if (estudiante.promedio_general < 3.5) {
                probabilidad += 0.4;
            } else if (estudiante.promedio_general < 4.0) {
                probabilidad += 0.2;
            } else {
                probabilidad += 0.05;
            }

            // Factor 2: Diferencia entre consolidados (20% de peso)
            const diferencia = Math.abs(estudiante.promedio_cons1 - estudiante.promedio_cons2);
            if (diferencia > 0.5) {
                probabilidad += 0.15;
            } else if (diferencia > 0.3) {
                probabilidad += 0.1;
            }

            // Factor 3: Tendencia (20% de peso)
            if (estudiante.promedio_cons2 < estudiante.promedio_cons1) {
                probabilidad += 0.15;
            }

            // Ajustar con tasa base del modelo
            probabilidad = (probabilidad + modelo.tasaAbandonoBase) / 2;

            // Limitar entre 0 y 1
            probabilidad = Math.max(0, Math.min(1, probabilidad));

            const abandono = probabilidad > 0.5 ? 1 : 0;
            let nivelRiesgo = 'Bajo';
            if (probabilidad > 0.7) nivelRiesgo = 'Alto';
            else if (probabilidad > 0.4) nivelRiesgo = 'Medio';

            return { abandono, probabilidad, nivelRiesgo };
        }

        function mostrarResultados(predicciones) {
            // KPIs
            const total = predicciones.length;
            const alto = predicciones.filter(p => p.nivel_riesgo === 'Alto').length;
            const medio = predicciones.filter(p => p.nivel_riesgo === 'Medio').length;
            const bajo = predicciones.filter(p => p.nivel_riesgo === 'Bajo').length;
            const abandonaran = predicciones.filter(p => p.prediccion_abandono === 1).length;

            const kpiHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">üë• Total Analizados</div>
                    <div class="kpi-value">${total}</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="kpi-label">üî¥ Riesgo Alto</div>
                    <div class="kpi-value">${alto}</div>
                    <div class="kpi-subtext">${(alto/total*100).toFixed(1)}%</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <div class="kpi-label">üü° Riesgo Medio</div>
                    <div class="kpi-value">${medio}</div>
                    <div class="kpi-subtext">${(medio/total*100).toFixed(1)}%</div>
                </div>
                <div class="kpi-card" style="background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);">
                    <div class="kpi-label">üü¢ Riesgo Bajo</div>
                    <div class="kpi-value">${bajo}</div>
                    <div class="kpi-subtext">${(bajo/total*100).toFixed(1)}%</div>
                </div>
            `;

            document.getElementById('kpiResults').innerHTML = kpiHTML;

            // Tabla de predicciones
            let tablaHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nombre Completo</th>
                            <th>Edad</th>
                            <th>Carrera</th>
                            <th>Cons 1</th>
                            <th>Cons 2</th>
                            <th>Promedio</th>
                            <th>Predicci√≥n</th>
                            <th>Probabilidad</th>
                            <th>Nivel Riesgo</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            predicciones.forEach((p, i) => {
                const badgeRiesgo = p.nivel_riesgo === 'Alto' ? 'badge-riesgo-alto' : 
                                   p.nivel_riesgo === 'Medio' ? 'badge-riesgo-medio' : 'badge-riesgo-bajo';
                
                const iconoPrediccion = p.prediccion_abandono === 1 ? '‚ùå' : '‚úÖ';
                const textoPrediccion = p.prediccion_abandono === 1 ? 'Abandonar√°' : 'Continuar√°';

                tablaHTML += `
                    <tr>
                        <td>${i + 1}</td>
                        <td><strong>${p.nombre} ${p.apellido}</strong></td>
                        <td>${p.edad}</td>
                        <td>${p.carrera}</td>
                        <td>${p.promedio_cons1.toFixed(2)}</td>
                        <td>${p.promedio_cons2.toFixed(2)}</td>
                        <td><strong>${p.promedio_general.toFixed(2)}</strong></td>
                        <td>${iconoPrediccion} ${textoPrediccion}</td>
                        <td>${(p.probabilidad * 100).toFixed(1)}%</td>
                        <td><span class="badge ${badgeRiesgo}">${p.nivel_riesgo}</span></td>
                    </tr>
                `;
            });

            tablaHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('tableResults').innerHTML = tablaHTML;

            // Generar gr√°ficas
            generarGraficasResultados(predicciones);
        }

        function generarGraficasResultados(predicciones) {
            // 1. Gr√°fica de Abandono por Carrera
            const carreraStats = {};
            predicciones.forEach(p => {
                if (!carreraStats[p.carrera]) {
                    carreraStats[p.carrera] = { total: 0, abandonan: 0 };
                }
                carreraStats[p.carrera].total++;
                if (p.prediccion_abandono === 1) {
                    carreraStats[p.carrera].abandonan++;
                }
            });

            const carreras = Object.keys(carreraStats);
            const tasasAbandono = carreras.map(c => 
                (carreraStats[c].abandonan / carreraStats[c].total * 100).toFixed(1)
            );

            if (window.chartCarreraAbandonoInstance) {
                window.chartCarreraAbandonoInstance.destroy();
            }

            window.chartCarreraAbandonoInstance = new Chart(document.getElementById('chartCarreraAbandono'), {
                type: 'bar',
                data: {
                    labels: carreras,
                    datasets: [{
                        label: 'Tasa de Abandono (%)',
                        data: tasasAbandono,
                        backgroundColor: tasasAbandono.map(t => {
                            const val = parseFloat(t);
                            if (val > 60) return '#e74c3c';
                            if (val > 40) return '#f39c12';
                            return '#00b894';
                        }),
                        borderColor: '#333',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const carrera = context.label;
                                    const stats = carreraStats[carrera];
                                    return [
                                        `Tasa: ${context.parsed.y}%`,
                                        `Abandonan: ${stats.abandonan}/${stats.total}`
                                    ];
                                }
                            }
                        }
                    }
                }
            });

            // 2. Gr√°fica de Total por Carrera
            const totales = carreras.map(c => carreraStats[c].total);

            if (window.chartCarreraTotalInstance) {
                window.chartCarreraTotalInstance.destroy();
            }

            window.chartCarreraTotalInstance = new Chart(document.getElementById('chartCarreraTotal'), {
                type: 'doughnut',
                data: {
                    labels: carreras,
                    datasets: [{
                        data: totales,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#4facfe',
                            '#43e97b', '#fa709a', '#fee140', '#30cfd0'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.parsed;
                                    const porcentaje = (total / predicciones.length * 100).toFixed(1);
                                    return `${context.label}: ${total} (${porcentaje}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // 3. Gr√°fica de Abandono por G√©nero
            const generoStats = {};
            predicciones.forEach(p => {
                if (!generoStats[p.genero]) {
                    generoStats[p.genero] = { total: 0, abandonan: 0, continuan: 0 };
                }
                generoStats[p.genero].total++;
                if (p.prediccion_abandono === 1) {
                    generoStats[p.genero].abandonan++;
                } else {
                    generoStats[p.genero].continuan++;
                }
            });

            const generos = Object.keys(generoStats);
            const abandonanPorGenero = generos.map(g => generoStats[g].abandonan);
            const continuanPorGenero = generos.map(g => generoStats[g].continuan);

            if (window.chartGeneroAbandonoInstance) {
                window.chartGeneroAbandonoInstance.destroy();
            }

            window.chartGeneroAbandonoInstance = new Chart(document.getElementById('chartGeneroAbandono'), {
                type: 'bar',
                data: {
                    labels: generos,
                    datasets: [{
                        label: '‚ùå Abandonan',
                        data: abandonanPorGenero,
                        backgroundColor: '#e74c3c',
                        borderColor: '#c0392b',
                        borderWidth: 2
                    }, {
                        label: '‚úÖ Contin√∫an',
                        data: continuanPorGenero,
                        backgroundColor: '#00b894',
                        borderColor: '#00a383',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const genero = context.label;
                                    const total = generoStats[genero].total;
                                    const porcentaje = (context.parsed.y / total * 100).toFixed(1);
                                    return `${context.dataset.label}: ${context.parsed.y} (${porcentaje}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funciones de utilidad
        function limpiarDatos(datos, requiereAbandono = true) {
            const nombresHombres = ['Juan', 'Carlos', 'Miguel', 'Luis', 'Pedro', 'Diego', 'Andr√©s', 'Jos√©'];
            const nombresMujeres = ['Ana', 'Mar√≠a', 'Laura', 'Sof√≠a', 'Carmen', 'Patricia', 'Isabel', 'Gabriela'];
            const apellidosComunes = ['Garc√≠a', 'Rodr√≠guez', 'L√≥pez', 'Mart√≠nez', 'Gonz√°lez', 'P√©rez', 'S√°nchez', 'Ram√≠rez'];

            return datos.map((d, index) => {
                let nombre = d.nombre || d.Nombre;
                if (!nombre) {
                    const genero = d.genero || d.Genero || 'Hombre';
                    nombre = genero.toLowerCase().includes('mujer') ? 
                            nombresMujeres[index % nombresMujeres.length] : 
                            nombresHombres[index % nombresHombres.length];
                }
                
                let apellido = d.apellido || d.Apellido;
                if (!apellido) {
                    apellido = apellidosComunes[index % apellidosComunes.length];
                }

                let promedio1 = parseFloat(d.promedio_cons1);
                let promedio2 = parseFloat(d.promedio_cons2);

                // Convertir escala si es necesario
                if (promedio1 > 10) {
                    promedio1 = ((promedio1 / 20) * 4) + 1;
                } else if (promedio1 > 5) {
                    promedio1 = ((promedio1 / 10) * 4) + 1;
                }

                if (promedio2 > 10) {
                    promedio2 = ((promedio2 / 20) * 4) + 1;
                } else if (promedio2 > 5) {
                    promedio2 = ((promedio2 / 10) * 4) + 1;
                }

                promedio1 = Math.max(1, Math.min(5, promedio1));
                promedio2 = Math.max(1, Math.min(5, promedio2));

                const resultado = {
                    nombre,
                    apellido,
                    edad: parseFloat(d.edad) || 20,
                    genero: d.genero || 'No especificado',
                    carrera: d.carrera || 'General',
                    promedio_cons1: promedio1,
                    promedio_cons2: promedio2,
                    promedio_general: (promedio1 + promedio2) / 2
                };

                if (requiereAbandono) {
                    resultado.abandono = parseInt(d.abandono) || 0;
                }

                return resultado;
            }).filter(d => !isNaN(d.promedio_cons1) && !isNaN(d.promedio_cons2));
        }

        // Generar datos de ejemplo
        function generarEjemploEntrenamiento() {
            const ejemploEntrenamiento = [
                {nombre: 'Juan', apellido: 'P√©rez', edad: 22, genero: 'Hombre', carrera: 'Ingenier√≠a', promedio_cons1: 3.2, promedio_cons2: 3.0, abandono: 1},
                {nombre: 'Ana', apellido: 'Garc√≠a', edad: 19, genero: 'Mujer', carrera: 'Medicina', promedio_cons1: 4.5, promedio_cons2: 4.3, abandono: 0},
                {nombre: 'Carlos', apellido: 'L√≥pez', edad: 25, genero: 'Hombre', carrera: 'Derecho', promedio_cons1: 2.1, promedio_cons2: 2.0, abandono: 1},
                {nombre: 'Mar√≠a', apellido: 'Rodr√≠guez', edad: 20, genero: 'Mujer', carrera: 'Psicolog√≠a', promedio_cons1: 3.8, promedio_cons2: 3.9, abandono: 0},
                {nombre: 'Laura', apellido: 'Mart√≠nez', edad: 23, genero: 'Mujer', carrera: 'Administraci√≥n', promedio_cons1: 3.5, promedio_cons2: 3.6, abandono: 0},
                {nombre: 'Pedro', apellido: 'S√°nchez', edad: 21, genero: 'Hombre', carrera: 'Arte', promedio_cons1: 2.8, promedio_cons2: 2.9, abandono: 1},
                {nombre: 'Diego', apellido: 'Torres', edad: 24, genero: 'Hombre', carrera: 'Ingenier√≠a', promedio_cons1: 3.1, promedio_cons2: 3.3, abandono: 1},
                {nombre: 'Sof√≠a', apellido: 'Ram√≠rez', edad: 18, genero: 'Mujer', carrera: 'Medicina', promedio_cons1: 4.2, promedio_cons2: 4.1, abandono: 0},
                {nombre: 'Miguel', apellido: 'Fern√°ndez', edad: 26, genero: 'Hombre', carrera: 'Derecho', promedio_cons1: 1.9, promedio_cons2: 1.8, abandono: 1},
                {nombre: 'Isabel', apellido: 'Castro', edad: 22, genero: 'Mujer', carrera: 'Psicolog√≠a', promedio_cons1: 3.7, promedio_cons2: 4.0, abandono: 0},
                {nombre: 'Roberto', apellido: 'Vargas', edad: 20, genero: 'Hombre', carrera: 'Ingenier√≠a', promedio_cons1: 4.1, promedio_cons2: 4.2, abandono: 0},
                {nombre: 'Carmen', apellido: 'Ruiz', edad: 21, genero: 'Mujer', carrera: 'Administraci√≥n', promedio_cons1: 3.3, promedio_cons2: 3.4, abandono: 0},
                {nombre: 'Andr√©s', apellido: 'Morales', edad: 23, genero: 'Hombre', carrera: 'Arte', promedio_cons1: 2.5, promedio_cons2: 2.4, abandono: 1},
                {nombre: 'Valentina', apellido: 'Silva', edad: 19, genero: 'Mujer', carrera: 'Medicina', promedio_cons1: 4.7, promedio_cons2: 4.8, abandono: 0},
                {nombre: 'Luis', apellido: 'Jim√©nez', edad: 24, genero: 'Hombre', carrera: 'Derecho', promedio_cons1: 3.0, promedio_cons2: 3.1, abandono: 0}
            ];

            entrenarModelo(ejemploEntrenamiento);
        }

        function generarEjemploPrediccion() {
            const ejemploPrediccion = [
                {nombre: 'Camila', apellido: 'Herrera', edad: 21, genero: 'Mujer', carrera: 'Ingenier√≠a', promedio_cons1: 2.9, promedio_cons2: 2.8},
                {nombre: 'Felipe', apellido: 'Mendoza', edad: 22, genero: 'Hombre', carrera: 'Medicina', promedio_cons1: 4.3, promedio_cons2: 4.4},
                {nombre: 'Daniela', apellido: 'Ortiz', edad: 20, genero: 'Mujer', carrera: 'Psicolog√≠a', promedio_cons1: 3.6, promedio_cons2: 3.7},
                {nombre: 'Santiago', apellido: 'Vega', edad: 23, genero: 'Hombre', carrera: 'Derecho', promedio_cons1: 2.3, promedio_cons2: 2.2},
                {nombre: 'Natalia', apellido: 'R√≠os', edad: 19, genero: 'Mujer', carrera: 'Administraci√≥n', promedio_cons1: 4.0, promedio_cons2: 4.1}
            ];

            hacerPredicciones(ejemploPrediccion);
        }

        function descargarPredicciones() {
            if (!prediccionesResultado) return;

            let csv = 'Nombre,Apellido,Edad,G√©nero,Carrera,Cons1,Cons2,Promedio,Predicci√≥n,Probabilidad,Nivel_Riesgo\n';
            prediccionesResultado.forEach(p => {
                csv += `${p.nombre},${p.apellido},${p.edad},${p.genero},${p.carrera},${p.promedio_cons1.toFixed(2)},${p.promedio_cons2.toFixed(2)},${p.promedio_general.toFixed(2)},${p.prediccion_abandono === 1 ? 'Abandonar√°' : 'Continuar√°'},${(p.probabilidad * 100).toFixed(1)}%,${p.nivel_riesgo}\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'predicciones_abandono.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function nuevaPrediccion() {
            actualizarProgreso(2);
            cambiarSeccion('section2');
        }

        function volverEtapa1() {
            if (confirm('¬øSeguro que quieres volver? Perder√°s el modelo entrenado actual.')) {
                modeloEntrenado = null;
                datosEntrenamiento = null;
                prediccionesResultado = null;
                actualizarProgreso(1);
                cambiarSeccion('section1');
            }
        }

        function volverInicio() {
            if (confirm('¬øSeguro que quieres volver al inicio? Perder√°s todo el progreso.')) {
                modeloEntrenado = null;
                datosEntrenamiento = null;
                prediccionesResultado = null;
                actualizarProgreso(1);
                cambiarSeccion('section1');
            }
        }

        function mostrarGuiaCompleta() {
            document.getElementById('modalGuia').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function cerrarGuiaCompleta() {
            document.getElementById('modalGuia').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Cerrar modal al hacer clic fuera
        document.getElementById('modalGuia').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarGuiaCompleta();
            }
        });
    </script>
</body>
</html>

